## variable scope and closure

### 코드 블록 '{}'

- code block 안에서 선언한 변수는 블록 안에서만 사용할 수 있다. 이런 특징은 특정 작업을 수행하는 코드를 한데 묶어두는 용도로 활용할 수 있다. 블록 안에는 작업 수행에만 필요한 변수가 선언된다.

- code block을 사용하는 if, for, while 등의 statement에서도 마찬가지로 '{}'안에서 선언한 변수는 오직 '{}' 안에서만 접근 가능하다.

- for의 '()'에서 선언한 변수는 '{}'안에서 선언한 변수로 취급한다.

### 중첩 함수(nested function)

- 중첩 함수는 함수 내부에서 선언한 함수를 의미한다.

- 중첩 함수는 새로운 객체의 프로퍼티 형태나 중첩 함수 그 자체로 반환될 수 있다. 반환된 중첩 함수는 어디서든 호출해 사용할 수 있다. 반환된 중첩 함수는 외부 변수에 접근할 수 있다.

### 렉시컬 환경(lexical environment)

#### 변수

- lexical environment는 실행 중인 함수, 코드 블록, 스크립트 전체가 갖는 내부 숨김 연관 객체(internal hidden associated object)이다.

- lexical environment는 environment record(환경 레코드)와 outer lexical environment(외부 렉시컬 환경)이라는 두 부분으로 구성된다.

- environment record는 모든 지역 변수를 프로퍼티로 저장하고 있는 객체다. 'this' 값과 같은 기타 정보도 여기에 저장된다.

- outer lexical environment는 외부의 lexical environment를 의미한다.

- 변수는 특수 내부 객체인 environment record의 프로퍼티다. 변수를 가져오거나 수정하는 것은 환경 레코드의 프로퍼티를 가져오거나 변경하는 것을 위미한다.

- global lexical environment(전역 렉시컬 환경)는 스크립트 전체와 관련된 환경을 의미한다.

- global lexical environment는 외부 참조를 갖지 않는다.

- 스크립트가 시작되면 스크립트 내에서 선언한 변수 전체가 lexical environment에 올라간다(pre-populated). 이때 변수의 상태는 특수 내부 상태(special internal state)인 'uninitialized'가 된다. 자바스크립트 엔진은 uninitialized 상태의 변수를 인지하긴 하지만 let을 만나기 전까지 해당 변수를 참조할 수 없다.

- let을 만나면 참조가 가능해지고 값을 할당하기 전에는 undefined값이 할당 된다.

- 렉시컬 환경은 명세서에서 자바스크립트가 어떻게 동작하는지 설명하는 데 쓰이는 이론상의 객체이다. 코드를 사용해 직접 렉시컬 환경을 얻거나 조작하는 것을 불가능하다.

- 자바스크립트 엔진들은 명세서에 언듭된 사항을 준수하면서 엔진 고유의 방법을 사용해 렉시컬 환경을 최적화한다.

#### 함수 선언문

- function declaration으로 선언한 함수는 일반 변수와는 달리 바로 초기화된다는 점에서 차이가 있다. 함수 선언문으로 선언한 함수는 렉시컬 환경우 만들어지는 즉시 사용할 수 있다. 이러한 이유로 함수를 선언하기 전에 함수를 사용할 수 있다. function expression(함수 표현식)

#### 내부와 외부 렉시컬 환경

- 함수를 호출해 실행하면 새로운 렉시컬 환경이 자동으로 만들어진다. 해당 렉시컬 환경에는 함수 호출 시 넘겨받은 매개변수와 함수의 지역 변수가 저장된다. 

- 함수가 호출 중인 동안에 해당 함수는 내부 렉시컬 환경과 내부 렉시컬 환경이 가리키는 외부 렉시컬 환경을 갖게 된다.

- 내부 렉시컬 환경은 외부 렉시컬 환경에 대한 참조를 가진다.

- 코드에서 변수에 접근할 때는 내부 렉시컬 환경을 우선 검색 범위로 잡는다. 내부 렉시컬 환경에서 원하는 변수를 찾지 못할 경우 검색 범위를 내부 렉시컬 환경이 참조하는 외부 렉시컬 환경으로 확장한다. 이 과정은 검색 범위가 전역 렉시컬 환경으로 확장될 때까지 반복된다.

- 전역 레시컬 환경에 도달할 때까지 변수를 찾지 못하면 strict mode에서는 에러가 발생한다. 비 엄격모드에서는 정의되지 않은 변수에 값을 할당하려고하면 에러가 발생하는 대신 새로운 전역 변수가 만들어진다.

#### 함수를 반환하는 함수

- 모든 함수는 함수가 생성된 곳의 렉시컬 환경을 기억한다. 함수는 '\[\[Environment\]\]'라고 불리는 숨김 프로퍼티에 함수가 만들어진 곳의 렉시컬 환경에 대한 참조가 저장된다.

- '\[\[Environment\]\]' 프로퍼티의 값은 함수가 생성될 때 단 한 번 값이 세팅되고 영구적으로 변하지 않는다.

- 변수값의 갱신은 변수가 저장된 렉시컬 환경에서 실행된다.

- closure(클로저)는 외부 변수를 기억하고 이 외부 변수에 접근할 수 있는 함수를 의미한다. 자바스크립트에서는 new Function() 문법을 사용해 만든 함수를 제외하고 모든 함수가 외부 렉시컬을 참조하기 때문에 자연스럽게 클로저가 된다.

### 가비지 컬렉션

- 도달 가능한 중첩 함수의 '\[\[Environment\]\]' 프로퍼티에 저장되어있는 외부 함수의 렉시컬 환경은 도달 가능한 상태이다. 외부 함수의 호출은 끝났지만 외부 함수의 렉시컬 환경이 메모리에서 삭제되지 않고 유지되는 이유는 이 때문이다.

- 중첩 함수를 사용할 때는 호출 시 만들어지는 각 렉시컬 환경 모두가 중첩 함수가 도달 가능한 상태인 경우 메모리에서 삭제되지 않는다는 점에 주의해야 한다.

#### 자바스크립트 엔진 최적화 프로세스

- 이론상으로 중첩 함수가 살아있는 동안에는 외부 변수 역시 메모리에 유지되지만 실제로는 자바스크립트 엔진이 이를 지속해서 최적화한다. 자바스크립트 엔진은 변수 사용을 분석하고 외부 변수가 사용되지 않는다고 판단되면 이를 메모리에서 제거한다. 

- 디버깅 시, 최적화 과정에서 제거된 변수를 사용할 수 없다는 점은 V8엔진의 주요 부작용이다.

### 참조
---

- [모던 JavaScript 튜토리얼 - 6.3 변수 유효 범위와 클로저](https://ko.javascript.info/closure)